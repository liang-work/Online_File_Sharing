{% extends "base.html" %}

{% block title %}上传文件 - 文件分享系统{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header text-center">
                <h4 class="mb-0">
                    <i class="fas fa-cloud-upload-alt me-2"></i>上传文件
                </h4>
            </div>
            <div class="card-body">
                <!-- 上传模式提示 -->
                <div class="mb-3">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        系统会根据文件大小自动选择最合适的上传方式：<br>
                        • 小文件（≤10MB）：普通上传<br>
                        • 大文件（>10MB）：分块上传（支持断点续传）
                    </div>
                </div>

                <!-- 普通上传表单 -->
                <div id="normalUploadForm">
                    <form method="POST" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            {{ form.files.label(class="form-label") }}
                            <input type="file" name="files" class="form-control" multiple required>
                            <div class="form-text">
                                支持选择多个文件或整个目录
                            </div>
                            {% if form.files.errors %}
                                <div class="text-danger small">
                                    {% for error in form.files.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                    <div class="mb-3">
                        {{ form.share_type.label(class="form-label") }}
                        {{ form.share_type(class="form-select") }}
                        <div class="form-text">
                            选择文件的分享方式
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">权限设置</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.allow_view(class="form-check-input") }}
                                    {{ form.allow_view.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.allow_download(class="form-check-input") }}
                                    {{ form.allow_download.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.allow_edit(class="form-check-input") }}
                                    {{ form.allow_edit.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>
                        <div class="form-text">
                            设置其他用户对文件的操作权限
                        </div>
                    </div>

                    <div class="mb-3" id="allowedUsersGroup" style="display: none;">
                        {{ form.allowed_users.label(class="form-label") }}
                        {{ form.allowed_users(class="form-control", rows="3", placeholder="输入用户名，每行一个") }}
                        <div class="form-text">
                            只有列出的用户才能访问此文件
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form.expiry_type.label(class="form-label") }}
                        {{ form.expiry_type(class="form-select") }}
                    </div>

                    <div class="mb-3" id="expiryHoursGroup" style="display: none;">
                        {{ form.expiry_hours.label(class="form-label") }}
                        {{ form.expiry_hours(class="form-select") }}
                        <div class="form-text">
                            选择预设的过期时间
                        </div>
                    </div>

                    <div class="mb-3" id="customExpiryGroup" style="display: none;">
                        {{ form.custom_expiry.label(class="form-label") }}
                        {{ form.custom_expiry(class="form-control", placeholder="YYYY-MM-DD HH:MM") }}
                        <div class="form-text">
                            自定义过期时间，格式：年-月-日 时:分
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form.password.label(class="form-label") }}
                        {{ form.password(class="form-control") }}
                        <div class="form-text">
                            可选：设置访问密码（留空则不设置密码）
                        </div>
                        {% if form.password.errors %}
                            <div class="text-danger small">
                                {% for error in form.password.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="d-grid">
                        {{ form.submit(class="btn btn-primary btn-lg") }}
                    </div>
                </form>
                </div>

                <!-- 分块上传界面 -->
                <div id="chunkUploadForm" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">选择文件</label>
                        <input type="file" id="chunkFileInput" class="form-control" accept="*/*">
                        <div class="form-text">
                            选择要分块上传的文件（支持大文件）
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">分块大小</label>
                        <select id="chunkSize" class="form-select">
                            <option value="1048576">1MB</option>
                            <option value="5242880" selected>5MB</option>
                            <option value="10485760">10MB</option>
                            <option value="20971520">20MB</option>
                        </select>
                        <div class="form-text">
                            选择文件分块的大小
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="button" id="startChunkUpload" class="btn btn-success btn-lg" disabled>
                            <i class="fas fa-play me-2"></i>开始分块上传
                        </button>
                    </div>

                    <!-- 上传进度 -->
                    <div id="uploadProgress" class="mt-3" style="display: none;">
                        <div class="mb-2">
                            <strong>上传进度</strong>
                        </div>
                        <div class="progress mb-2">
                            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-muted small">
                            <span id="progressText">准备上传...</span>
                        </div>
                        <div class="mt-2">
                            <button type="button" id="pauseUpload" class="btn btn-warning btn-sm me-2">
                                <i class="fas fa-pause me-1"></i>暂停
                            </button>
                            <button type="button" id="resumeUpload" class="btn btn-success btn-sm" style="display: none;">
                                <i class="fas fa-play me-1"></i>继续
                            </button>
                            <button type="button" id="cancelUpload" class="btn btn-danger btn-sm">
                                <i class="fas fa-times me-1"></i>取消
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>上传说明
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>智能上传</strong>：系统自动根据文件大小选择最优上传方式
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>大文件支持</strong>：分块上传支持断点续传，文件大小无限制
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        支持上传多个小文件或单个大文件
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        可以设置文件为公开或私密分享
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        可设置访问密码保护文件
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        支持设置文件过期时间
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
// 分块上传相关变量
let currentFile = null;
let fileHash = null;
let taskId = null;
let chunkSize = 5 * 1024 * 1024; // 5MB
let chunksCount = 0;
let uploadedChunks = new Set();
let isPaused = false;
let isUploading = false;

document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.querySelector('input[name="files"]');
    const uploadButton = document.querySelector('button[type="submit"]');
    const shareTypeSelect = document.querySelector('select[name="share_type"]');
    const expiryTypeSelect = document.querySelector('select[name="expiry_type"]');
    const allowedUsersGroup = document.getElementById('allowedUsersGroup');
    const expiryHoursGroup = document.getElementById('expiryHoursGroup');
    const customExpiryGroup = document.getElementById('customExpiryGroup');

    const normalUploadForm = document.getElementById('normalUploadForm');
    const chunkUploadForm = document.getElementById('chunkUploadForm');

    // 文件选择事件 - 自动选择上传模式
    fileInput.addEventListener('change', function() {
        const files = this.files;
        if (files.length === 0) {
            uploadButton.innerHTML = '<i class="fas fa-upload me-2"></i>上传';
            return;
        }

        // 检查是否有大文件（超过10MB）
        const hasLargeFile = Array.from(files).some(file => file.size > 10 * 1024 * 1024);

        if (hasLargeFile) {
            // 显示分块上传界面
            normalUploadForm.style.display = 'none';
            chunkUploadForm.style.display = 'block';

            // 设置分块上传的文件
            const chunkFileInput = document.getElementById('chunkFileInput');
            const startChunkUpload = document.getElementById('startChunkUpload');

            if (files.length === 1) {
                // 单个大文件，使用分块上传
                currentFile = files[0];
                startChunkUpload.disabled = false;
                startChunkUpload.innerHTML = '<i class="fas fa-play me-2"></i>开始上传 ' + currentFile.name;
            } else {
                // 多个文件中有大文件，提示用户逐个上传
                alert('检测到大文件，请逐个上传大文件。普通文件请重新选择。');
                this.value = '';
                return;
            }
        } else {
            // 显示普通上传界面
            normalUploadForm.style.display = 'block';
            chunkUploadForm.style.display = 'none';
            uploadButton.innerHTML = '<i class="fas fa-upload me-2"></i>上传 ' + files.length + ' 个文件';
        }
    });

    // 分享类型选择事件
    shareTypeSelect.addEventListener('change', function() {
        if (this.value === 'specified_users') {
            allowedUsersGroup.style.display = 'block';
        } else {
            allowedUsersGroup.style.display = 'none';
        }
    });

    // 过期类型选择事件
    expiryTypeSelect.addEventListener('change', function() {
        expiryHoursGroup.style.display = 'none';
        customExpiryGroup.style.display = 'none';

        if (this.value === 'hours') {
            expiryHoursGroup.style.display = 'block';
        } else if (this.value === 'custom') {
            customExpiryGroup.style.display = 'block';
        }
    });

    // 分块上传相关事件
    const chunkFileInput = document.getElementById('chunkFileInput');
    const chunkSizeSelect = document.getElementById('chunkSize');
    const startChunkUpload = document.getElementById('startChunkUpload');
    const pauseUpload = document.getElementById('pauseUpload');
    const resumeUpload = document.getElementById('resumeUpload');
    const cancelUpload = document.getElementById('cancelUpload');

    chunkFileInput.addEventListener('change', function() {
        currentFile = this.files[0];
        startChunkUpload.disabled = !currentFile;
        if (currentFile) {
            startChunkUpload.innerHTML = '<i class="fas fa-play me-2"></i>开始上传 ' + currentFile.name;
        }
    });

    chunkSizeSelect.addEventListener('change', function() {
        chunkSize = parseInt(this.value);
    });

    startChunkUpload.addEventListener('click', startUpload);
    pauseUpload.addEventListener('click', pauseUploadProcess);
    resumeUpload.addEventListener('click', resumeUploadProcess);
    cancelUpload.addEventListener('click', cancelUploadProcess);

    // 初始化显示状态
    shareTypeSelect.dispatchEvent(new Event('change'));
    expiryTypeSelect.dispatchEvent(new Event('change'));
});

// 计算文件哈希
async function calculateFileHash(file) {
    const buffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// 创建上传任务
async function createUploadTask() {
    const response = await fetch('/api/files/upload/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            hash: fileHash,
            file_name: currentFile.name,
            file_size: currentFile.size,
            content_type: currentFile.type || 'application/octet-stream',
            chunk_size: chunkSize
        })
    });

    const result = await response.json();

    if (!response.ok) {
        throw new Error(result.error || '创建上传任务失败');
    }

    return result;
}

// 上传单个分块
async function uploadChunk(chunkIndex) {
    const start = chunkIndex * chunkSize;
    const end = Math.min(start + chunkSize, currentFile.size);
    const chunk = currentFile.slice(start, end);

    const formData = new FormData();
    formData.append('chunk', chunk);

    const response = await fetch(`/api/files/upload/chunk/${taskId}/${chunkIndex}`, {
        method: 'POST',
        body: formData
    });

    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || '上传分块失败');
    }

    uploadedChunks.add(chunkIndex);
}

// 完成上传
async function completeUpload() {
    const response = await fetch(`/api/files/upload/complete/${taskId}`, {
        method: 'POST'
    });

    const result = await response.json();

    if (!response.ok) {
        throw new Error(result.error || '完成上传失败');
    }

    return result;
}

// 开始上传
async function startUpload() {
    if (!currentFile) return;

    try {
        // 显示进度
        document.getElementById('uploadProgress').style.display = 'block';
        document.getElementById('startChunkUpload').disabled = true;

        updateProgress(0, '计算文件哈希...');

        // 计算文件哈希
        fileHash = await calculateFileHash(currentFile);

        updateProgress(10, '创建上传任务...');

        // 创建上传任务
        const taskResult = await createUploadTask();

        if (taskResult.file_exists) {
            updateProgress(100, '文件已存在，上传完成');
            alert('文件已存在，无需重复上传');
            resetUpload();
            return;
        }

        taskId = taskResult.task_id;
        chunksCount = taskResult.chunks_count;

        updateProgress(20, '开始上传分块...');

        // 开始上传分块
        isUploading = true;
        await uploadAllChunks();

    } catch (error) {
        console.error('上传失败:', error);
        updateProgress(0, '上传失败: ' + error.message);
        alert('上传失败: ' + error.message);
        resetUpload();
    }
}

// 上传所有分块
async function uploadAllChunks() {
    for (let i = 0; i < chunksCount; i++) {
        if (!isUploading) break;

        while (isPaused) {
            await new Promise(resolve => setTimeout(resolve, 100));
            if (!isUploading) return;
        }

        try {
            updateProgress(20 + (i / chunksCount) * 70, `上传分块 ${i + 1}/${chunksCount}...`);
            await uploadChunk(i);
        } catch (error) {
            console.error(`分块 ${i} 上传失败:`, error);
            // 可以在这里添加重试逻辑
            throw error;
        }
    }

    if (isUploading) {
        updateProgress(90, '完成上传...');
        await completeUpload();
        updateProgress(100, '上传完成！');
        alert('文件上传成功！');
        resetUpload();
    }
}

// 暂停上传
function pauseUploadProcess() {
    isPaused = true;
    document.getElementById('pauseUpload').style.display = 'none';
    document.getElementById('resumeUpload').style.display = 'inline-block';
    updateProgress(null, '上传已暂停');
}

// 继续上传
function resumeUploadProcess() {
    isPaused = false;
    document.getElementById('pauseUpload').style.display = 'inline-block';
    document.getElementById('resumeUpload').style.display = 'none';
    updateProgress(null, '继续上传...');
}

// 取消上传
function cancelUploadProcess() {
    isUploading = false;
    isPaused = false;
    resetUpload();
    updateProgress(0, '上传已取消');
}

// 更新进度
function updateProgress(percent, text) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    if (percent !== null) {
        progressBar.style.width = percent + '%';
    }
    progressText.textContent = text;
}

// 重置上传状态
function resetUpload() {
    currentFile = null;
    fileHash = null;
    taskId = null;
    uploadedChunks.clear();
    isPaused = false;
    isUploading = false;

    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('startChunkUpload').disabled = true;
    document.getElementById('startChunkUpload').innerHTML = '<i class="fas fa-play me-2"></i>开始分块上传';
    document.getElementById('pauseUpload').style.display = 'inline-block';
    document.getElementById('resumeUpload').style.display = 'none';
    document.getElementById('chunkFileInput').value = '';
}
</script>
{% endblock %}
{% endblock %}
