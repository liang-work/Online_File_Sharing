{% extends "base.html" %}

{% block title %}文件管理 - 文件分享系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-file-alt me-2"></i>文件管理
                </h4>
                <a href="{{ url_for('admin.admin_users') }}" class="btn btn-outline-primary">
                    <i class="fas fa-users me-1"></i>用户管理
                </a>
            </div>
            <div class="card-body">
                {% if files %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="selectAllFiles()">
                                    <i class="fas fa-check-square me-1"></i>全选
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="deselectAllFiles()">
                                    <i class="fas fa-square me-1"></i>取消全选
                                </button>
                                <span id="selectedCount" class="text-muted">已选择 0 个文件</span>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="batchDeleteFiles()" id="batchDeleteBtn" style="display: none;">
                                    <i class="fas fa-trash me-1"></i>批量删除
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="selectAll" onchange="toggleAllSelection()">
                                    </th>
                                    <th>ID</th>
                                    <th>文件名</th>
                                    <th>上传者</th>
                                    <th>大小</th>
                                    <th>分享类型</th>
                                    <th>权限</th>
                                    <th>上传时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in files %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="file-checkbox" value="{{ file.id }}" onchange="updateSelectionCount()">
                                        </td>
                                        <td>{{ file.id }}</td>
                                        <td>
                                            <strong title="{{ file.raw_filename or file.original_filename|e }}">{{ ((file.raw_filename or file.original_filename)|e)[:25] }}{% if (file.raw_filename or file.original_filename)|length > 25 %}...{% endif %}</strong>
                                        </td>
                                        <td>{{ file.user.username }}</td>
                                        <td>未知</td>
                                        <td>
                                            {% if file.share_type == 'public' %}
                                                <span class="badge bg-success">公开</span>
                                            {% elif file.share_type == 'link_only' %}
                                                <span class="badge bg-info">链接分享</span>
                                            {% elif file.share_type == 'specified_users' %}
                                                <span class="badge bg-warning">指定用户</span>
                                            {% else %}
                                                <span class="badge bg-secondary">未知</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if file.allow_download %}
                                                <i class="fas fa-download text-success me-2" title="允许下载"></i>
                                            {% else %}
                                                <i class="fas fa-download text-muted me-2" title="禁止下载"></i>
                                            {% endif %}
                                            {% if file.allow_view %}
                                                <i class="fas fa-eye text-success me-2" title="允许查看"></i>
                                            {% else %}
                                                <i class="fas fa-eye text-muted me-2" title="禁止查看"></i>
                                            {% endif %}
                                            {% if file.allow_edit %}
                                                <i class="fas fa-edit text-success" title="允许编辑"></i>
                                            {% else %}
                                                <i class="fas fa-edit text-muted" title="禁止编辑"></i>
                                            {% endif %}
                                        </td>
                                        <td>{{ file.upload_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{ url_for('admin.admin_edit_file', file_id=file.id) }}"
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <form method="POST" action="{{ url_for('admin.admin_delete_file', file_id=file.id) }}"
                                                      class="d-inline">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-folder-open text-muted empty-icon"></i>
                        <h5 class="mt-3 text-muted">暂无文件</h5>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>文件统计
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h3 class="text-primary">{{ files|length if files else 0 }}</h3>
                            <p class="mb-0">总文件数</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h3 class="text-success">
                                {% set public_count = 0 %}
                                {% if files %}
                                    {% for file in files %}
                                        {% if file.share_type == 'public' %}
                                            {% set public_count = public_count + 1 %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {{ public_count }}
                            </h3>
                            <p class="mb-0">公开文件</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h3 class="text-info">
                                {% set link_count = 0 %}
                                {% if files %}
                                    {% for file in files %}
                                        {% if file.share_type == 'link_only' %}
                                            {% set link_count = link_count + 1 %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {{ link_count }}
                            </h3>
                            <p class="mb-0">链接分享文件</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h3 class="text-warning">
                                {% set private_count = 0 %}
                                {% if files %}
                                    {% for file in files %}
                                        {% if file.share_type == 'specified_users' %}
                                            {% set private_count = private_count + 1 %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {{ private_count }}
                            </h3>
                            <p class="mb-0">指定用户文件</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
function selectAllFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = true);
    updateSelectionCount();
}

function deselectAllFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    updateSelectionCount();
}

function toggleAllSelection() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);
    updateSelectionCount();
}

function updateSelectionCount() {
    const checkboxes = document.querySelectorAll('.file-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = `已选择 ${count} 个文件`;

    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    if (count > 0) {
        batchDeleteBtn.style.display = 'inline-block';
    } else {
        batchDeleteBtn.style.display = 'none';
    }

    // 更新全选复选框状态
    const selectAllCheckbox = document.getElementById('selectAll');
    const allCheckboxes = document.querySelectorAll('.file-checkbox');
    const checkedCount = document.querySelectorAll('.file-checkbox:checked').length;
    selectAllCheckbox.checked = checkedCount === allCheckboxes.length && allCheckboxes.length > 0;
    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
}

function batchDeleteFiles() {
    const selectedFiles = document.querySelectorAll('.file-checkbox:checked');
    if (selectedFiles.length === 0) {
        alert('请先选择要删除的文件');
        return;
    }

    const fileIds = Array.from(selectedFiles).map(cb => cb.value);
    const confirmMessage = `确定要删除选中的 ${fileIds.length} 个文件吗？此操作不可撤销！`;

    if (confirm(confirmMessage)) {
        // 创建表单并提交
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/files/batch-delete';

        fileIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'file_ids';
            input.value = id;
            form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
    }
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    updateSelectionCount();
});
</script>
{% endblock %}
{% endblock %}
